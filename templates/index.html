<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario PUCP</title>
<meta name="robots" content="noindex, nofollow"><meta name="googlebot" content="noindex, nofollow">
<link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body>
  <header>
    <div class="brand">
      <img src="{{ url_for('static', filename='img/imagotipo-PUCP.png') }}" alt="PUCP">
      <h1>ALMACÉN DE ELECTRICIDAD Y ELECTRÓNICA</h1>
    </div>
    <div class="header-actions">
      {% if is_admin %}
        <span class="badge-admin">Admin</span>
        <a href="{{ url_for('users') }}">Usuarios</a>
        <a href="{{ url_for('logout') }}">Salir</a>
      {% else %}
        <a href="{{ url_for('login', next=request.full_path) }}">Iniciar sesión</a>
      {% endif %}
    </div>
  </header>

  <div class="layout">
    <div class="left-panel">
      <h2>Buscar artículo</h2>

      <form id="descForm" method="get" action="/buscar">
        <label for="desc">Por descripción</label>
        <input type="text" id="desc" name="desc" placeholder="Ej. osciloscopio, fuente, multímetro" autocomplete="off">
        <button type="submit">Buscar</button>
        <ul id="desc-suggest" class="suggestions"></ul>
      </form>

      <form id="codeForm" method="get" action="/">
        <label for="codigo">Por código</label>
        <input type="text" id="codigo" name="codigo" placeholder="Ej. A-01-1ALMINS00000067" autocomplete="off">
        <button type="submit">Buscar</button>
        <ul id="code-suggest" class="suggestions"></ul>
      </form>

      <form id="serieForm" method="get" action="/buscar">
        <label for="serie">Por Serie</label>
        <input type="text" id="serie" name="serie" placeholder="Ej. SN123456" autocomplete="off">
        <button type="submit">Buscar</button>
        <ul id="serie-suggest" class="suggestions"></ul>
      </form>

      <form id="actForm" method="get" action="/buscar">
        <label for="act">Por Act Fijo</label>
        <input type="text" id="act" name="act" placeholder="Ej. AF-000123" autocomplete="off">
        <button type="submit">Buscar</button>
        <ul id="act-suggest" class="suggestions"></ul>
      </form>
    </div>

    <div class="right-panel">
      {% if result %}
        {% if result.no_agregado %}
          <div class="err"><strong>{{ result.mensaje }}</strong></div>
          <button class="secondary" onclick="window.location.href='/'">← Regresar</button>
        {% else %}
          <div class="section">
            <h3>Campos fijos (Excel)</h3>
            <table>
              {% for key, value in result.fixed.items() if key not in ['link','documento'] %}
                <tr><th>{{ key }}</th><td>{{ value if value not in [None,'nan','NaN',''] else '-' }}</td></tr>
              {% endfor %}
            </table>
          </div>

          <div class="section">
            <h3>Foto del artículo</h3>
            <div class="foto-wrap">
              {% if result.foto_rel %}
                <img src="/fotos/{{ result.foto_rel }}" alt="Foto {{ result.codigo }}">
              {% else %}<div class="placeholder">No se encontró una imagen en la ruta esperada.</div>{% endif %}
            </div>
          </div>

          <div class="section">
            <h3>Estado y acciones</h3>
            <table>
              <tr><th>Estado</th>
                  <td><span class="estado {{ 'disponible' if result.variable.Estado == 'Disponible' else 'prestado' }}">{{ result.variable.Estado }}</span></td></tr>
              <tr><th>Prestado a</th><td>{{ result.variable.Prestado_a }}</td></tr>
              <tr><th>Fecha de préstamo</th><td>{{ result.variable.Fecha_de_prestamo }}</td></tr>
              <tr><th>Número de préstamos</th><td>{{ result.variable.Numero_prestamos }}</td></tr>
              <tr><th>Prestado por</th><td>{{ result.variable.Prestado_por }}</td></tr>
              <tr><th>Devuelto por</th><td>{{ result.variable.Devuelto_por }}</td></tr>
            </table>

            {% if is_admin %}
              {% if result.variable.Estado == 'Disponible' %}
                <form action="/prestar/{{ result['codigo'] }}" method="get" style="margin-top:15px;">
                  <button>Prestar</button>
                </form>
              {% else %}
                <form action="/devolver/{{ result['codigo'] }}" method="get" style="margin-top:15px;">
                  <button>Devolver</button>
                </form>
              {% endif %}
            {% else %}
              <p style="margin-top:12px;color:#555;">Solo lectura. <a href="{{ url_for('login', next=request.full_path) }}">Inicie sesión como administrador</a> para prestar o devolver.</p>
            {% endif %}
          </div>
        {% endif %}
      {% else %}
        <p>Ingrese una descripción, código, serie o act fijo para buscar un artículo.</p>
      {% endif %}
    </div>
  </div>

  <script>
    function setupAutocomplete(inputId, listId, kind, onPick) {
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      let lastController = null;

      input.addEventListener('input', async () => {
        const q = input.value.trim();
        if (q.length < 1) { list.style.display = 'none'; list.innerHTML=''; return; }
        try {
          if (lastController) lastController.abort();
          lastController = new AbortController();
          const res = await fetch(`/autocomplete?q=${encodeURIComponent(q)}&kind=${encodeURIComponent(kind)}`, { signal: lastController.signal });
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) { list.style.display = 'none'; return; }
          list.innerHTML = data.map(v => `<li data-v="${v.replace(/"/g,'&quot;')}">${v}</li>`).join('');
          list.style.display = 'block';
        } catch {}
      });

      list.addEventListener('click', e => {
        if (e.target.tagName === 'LI') {
          const val = e.target.getAttribute('data-v');
          input.value = val; list.style.display = 'none'; onPick(val);
        }
      });

      document.addEventListener('click', e => {
        if (!input.contains(e.target) && !list.contains(e.target)) list.style.display = 'none';
      });
    }
    setupAutocomplete('codigo','code-suggest','code', v => window.location.href='/' + encodeURIComponent(v.trim()));
    setupAutocomplete('desc','desc-suggest','desc', v => window.location.href='/buscar?desc=' + encodeURIComponent(v.trim()));
    setupAutocomplete('serie','serie-suggest','serie', v => window.location.href='/buscar?serie=' + encodeURIComponent(v.trim()));
    setupAutocomplete('act','act-suggest','act', v => window.location.href='/buscar?act=' + encodeURIComponent(v.trim()));
  </script>
</body>
</html>