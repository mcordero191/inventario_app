<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario PUCP</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #F9FAFB;
    color: #333;
    margin: 0;
    padding: 30px;
  }
  header {
    display: flex;
    align-items: center;
    border-bottom: 3px solid #002C77;
    padding-bottom: 15px;
    margin-bottom: 25px;
  }
  header img {
    height: 60px;
    margin-right: 20px;
  }
  h1 { color: #002C77; margin: 0; }
  h2 { color: #444; margin-top: 0; }
  form { margin-bottom: 20px; position: relative; }
  input[type="text"] {
    padding: 8px;
    width: 280px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: white;
    background: #0072CE;
  }
  button:hover { background: #005BB5; }
  .suggestions {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    list-style: none;
    margin-top: 4px;
    padding-left: 0;
    width: 280px;
    z-index: 1000;
  }
  .suggestions li { padding: 8px; cursor: pointer; }
  .suggestions li:hover { background: #E9ECF5; }
  table {
    border-collapse: collapse;
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    width: 600px;
  }
  th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
  th { background: #E9ECF5; text-transform: uppercase; }
  .estado { font-weight: bold; }
  .disponible { color: green; }
  .prestado { color: #B00020; }
</style>
</head>
<body>
  <header>
    <img src="https://red.pucp.edu.pe/riel/files/2019/07/LOGO-DE-PUCP.jpg" alt="PUCP">
    <h1>ALMACÉN DE ELECTRICIDAD Y ELECTRÓNICA</h1>
  </header>

  <h2>Búsqueda por:</h2>

  <form id="codeForm" method="get" action="/">
    <label for="codigo">Código:</label><br>
    <input type="text" id="codigo" name="codigo" placeholder="Ej. A-01-3ALMINS000037" autocomplete="off">
    <button type="submit">Buscar</button>
    <ul id="code-suggest" class="suggestions"></ul>
  </form>

  <form id="descForm" method="get" action="/buscar">
    <label for="desc">Descripción:</label><br>
    <input type="text" id="desc" name="desc" placeholder="Ej. osciloscopio, fuente, multímetro" autocomplete="off">
    <button type="submit">Buscar</button>
    <ul id="desc-suggest" class="suggestions"></ul>
  </form>

  {% if result %}
    {% if result.no_agregado %}
      <div style="background:#FFE5E5; color:#B00020; padding:15px; border-radius:6px; width:fit-content;">
        <strong>{{ result.mensaje }}</strong>
      </div>
      <button onclick="window.location.href='/'" style="margin-top:15px;">← Regresar al inicio</button>
    {% else %}
      <h3>Detalles del artículo</h3>
      <table>
        {% for key, value in result.items() %}
          {% if key not in ['Link', 'Documento', 'no_agregado', 'mensaje'] %}
            <tr>
              <th>{{ key.upper() }}</th>
              <td>
                {% if key == 'Estado' %}
                  <span class="estado {{ 'disponible' if value == 'Disponible' else 'prestado' }}">{{ value }}</span>
                {% else %}
                  {{ value if value not in [None, 'nan', 'NaN'] else '-' }}
                {% endif %}
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </table>

      {% if result.Estado == 'Disponible' %}
        <form action="/prestar/{{ result['Codigo'] }}" method="get" style="margin-top:15px;">
          <button>Prestar</button>
        </form>
      {% elif result.Estado == 'Prestado' %}
        <form action="/devolver/{{ result['Codigo'] }}" method="get" style="margin-top:15px;">
          <button>Devolver</button>
        </form>
      {% endif %}

      {% if result.Documento %}
        <div style="margin-top:25px;">
          <h3>Documento asociado</h3>
          {{ result.Documento|safe }}
        </div>
      {% endif %}
    {% endif %}
  {% endif %}

<script>
  function setupAutocomplete(inputId, listId, kind, onPick) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    let lastController = null;

    input.addEventListener('input', async () => {
      const q = input.value.trim();
      if (q.length < 1) { list.style.display = 'none'; list.innerHTML=''; return; }

      try {
        if (lastController) lastController.abort();
        lastController = new AbortController();
        const res = await fetch(`/autocomplete?q=${encodeURIComponent(q)}&kind=${encodeURIComponent(kind)}`, { signal: lastController.signal });
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) { list.style.display = 'none'; return; }
        list.innerHTML = data.map(v => `<li data-v="${v.replace(/"/g,'&quot;')}">${v}</li>`).join('');
        list.style.display = 'block';
      } catch {}
    });

    list.addEventListener('click', e => {
      if (e.target.tagName === 'LI') {
        const val = e.target.getAttribute('data-v');
        input.value = val;
        list.style.display = 'none';
        onPick(val);
      }
    });

    document.addEventListener('click', e => {
      if (!input.contains(e.target) && !list.contains(e.target)) list.style.display = 'none';
    });
  }

  setupAutocomplete('codigo', 'code-suggest', 'code', val => window.location.href = '/' + encodeURIComponent(val.trim()));
  setupAutocomplete('desc', 'desc-suggest', 'desc', val => window.location.href = '/buscar?desc=' + encodeURIComponent(val.trim()));
</script>
</body>
</html>
