<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario PUCP</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #F2F2F2; color: #333; }
  header { background-color: #002C77; padding: 20px; display: flex; align-items: center; color: white; }
  header img { height: 50px; margin-right: 20px; }
  h1 { font-size: 1.8em; margin: 0; }
  main { padding: 40px; }
  form { margin-bottom: 20px; position: relative; width: 320px; }
  input { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
  button { padding: 8px 14px; background: #0072CE; color: white; border: none; border-radius: 4px; cursor: pointer; }
  button:hover { background: #005BB5; }
  table { border-collapse: collapse; margin-top: 20px; width: 80%; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top; }
  th { background-color: #E9ECF5; width: 25%; text-transform: uppercase; letter-spacing: 0.5px; }
  td { white-space: pre-wrap; }
  .doc-section { margin-top: 40px; }
  ul.suggestions {
    list-style: none;
    position: absolute;
    top: 35px;
    width: 300px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 4px;
    max-height: 150px;
    overflow-y: auto;
    padding-left: 0;
    margin: 0;
    z-index: 100;
  }
  ul.suggestions li { padding: 8px; cursor: pointer; }
  ul.suggestions li:hover { background: #E9ECF5; }
  .doc-section h3 { color: #002C77; border-bottom: 2px solid #0072CE; display: inline-block; padding-bottom: 4px; }
</style>
</head>
<body>
  <header>
    <img src="https://red.pucp.edu.pe/riel/files/2019/07/LOGO-DE-PUCP.jpg" alt="PUCP">
    <h1>Consulta de Inventario PUCP</h1>
  </header>

  <main>
    <form id="searchForm" autocomplete="off">
        <input type="text" id="codigo" name="codigo" placeholder="Ingrese el cÃ³digo (e.g. A-01-3ALMINS000037)" required>
        <button type="submit">Buscar</button>
        <ul id="suggestions" class="suggestions" style="display:none;"></ul>
    </form>

    {% if result %}
      {% if result is string %}
        <p><strong>{{ result }}</strong></p>
      {% else %}
        <table>
          {% for key, value in result.items() %}
            {% if key not in ['Link', 'Documento'] %}
              <tr>
                <th>{{ key.upper() }}</th>
                <td>{{ value if value not in [None, 'nan', 'NaN'] else '-' | safe }}</td>
              </tr>
            {% endif %}
          {% endfor %}
        </table>

        {% if result.Documento %}
          <div class="doc-section">
            <h3>DOCUMENTO INCRUSTADO</h3>
            {{ result.Documento|safe }}
          </div>
        {% endif %}
      {% endif %}
    {% endif %}
  </main>

  <script>
    const form = document.getElementById('searchForm');
    const input = document.getElementById('codigo');
    const suggestions = document.getElementById('suggestions');

    // âœ… Redirigir al formato /codigo en vez de enviar POST
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const code = input.value.trim();
      if (code) window.location.href = '/' + encodeURIComponent(code);
    });

    // ðŸ” Autocompletado
    input.addEventListener('input', async () => {
      const query = input.value.trim();
      if (query.length < 2) { suggestions.style.display = 'none'; return; }
      const response = await fetch(`/autocomplete?q=${query}`);
      const data = await response.json();
      if (data.length === 0) { suggestions.style.display = 'none'; return; }

      suggestions.innerHTML = data.map(code => `<li>${code}</li>`).join('');
      suggestions.style.display = 'block';
    });

    suggestions.addEventListener('click', e => {
      if (e.target.tagName === 'LI') {
        input.value = e.target.textContent;
        suggestions.style.display = 'none';
        window.location.href = '/' + encodeURIComponent(input.value.trim());
      }
    });

    document.addEventListener('click', e => {
      if (!input.contains(e.target)) suggestions.style.display = 'none';
    });
  </script>
</body>
</html>
